<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Versions - n8n AI Assistant</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1e293b;
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }
        .button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #2563eb;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .error {
            background: #fef2f2;
            border-color: #fecaca;
            color: #dc2626;
        }
        .success {
            background: #f0fdf4;
            border-color: #bbf7d0;
            color: #166534;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            background: #f1f5f9;
            border-radius: 4px;
        }
        .log-entry.error {
            background: #fee2e2;
            color: #dc2626;
        }
        .log-entry.success {
            background: #dcfce7;
            color: #166534;
        }
        .log-entry.info {
            background: #dbeafe;
            color: #1e40af;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Versions - n8n AI Assistant</h1>
        
        <div class="section">
            <h2>üìä Test de r√©cup√©ration des versions</h2>
            <p>Cette page simule le comportement de l'extension pour r√©cup√©rer les versions des nodes n8n.</p>
            
            <button class="button" onclick="testLocalStorage()">1Ô∏è‚É£ V√©rifier le cache localStorage</button>
            <button class="button" onclick="testAPICall()">2Ô∏è‚É£ Tester l'API /rest/node-types</button>
            <button class="button" onclick="testInjectScript()">3Ô∏è‚É£ Tester via inject script</button>
            <button class="button" onclick="clearCache()">üóëÔ∏è Vider le cache</button>
            
            <div id="results" class="result" style="display: none;"></div>
        </div>

        <div class="section">
            <h2>üìù Logs en temps r√©el</h2>
            <div id="logs" style="max-height: 400px; overflow-y: auto;"></div>
        </div>

        <div class="section">
            <h2>üß™ Test complet de l'extension</h2>
            <button class="button" onclick="simulateFullFlow()">‚ñ∂Ô∏è Simuler le flux complet</button>
            <div id="flow-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Utilitaires de log
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.appendChild(entry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, message);
        }

        // Test 1: V√©rifier le cache localStorage
        function testLocalStorage() {
            log('üîç V√©rification du cache localStorage...', 'info');
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            
            try {
                const cached = localStorage.getItem('n8n-ai-node-versions');
                const timestamp = localStorage.getItem('n8n-ai-node-versions-timestamp');
                
                if (cached && timestamp) {
                    const versions = JSON.parse(cached);
                    const age = Date.now() - parseInt(timestamp);
                    const ageMinutes = Math.round(age / 1000 / 60);
                    
                    resultsDiv.className = 'result success';
                    resultsDiv.textContent = `‚úÖ Cache trouv√©!\n\n`;
                    resultsDiv.textContent += `√Çge: ${ageMinutes} minutes\n`;
                    resultsDiv.textContent += `Nombre de nodes: ${Object.keys(versions).length}\n\n`;
                    resultsDiv.textContent += `Exemples:\n`;
                    
                    const examples = Object.entries(versions).slice(0, 10);
                    examples.forEach(([node, version]) => {
                        resultsDiv.textContent += `  ${node}: ${version}\n`;
                    });
                    
                    if (Object.keys(versions).length > 10) {
                        resultsDiv.textContent += `  ... et ${Object.keys(versions).length - 10} autres\n`;
                    }
                    
                    log(`‚úÖ Cache trouv√©: ${Object.keys(versions).length} nodes, √¢ge: ${ageMinutes} min`, 'success');
                } else {
                    resultsDiv.className = 'result error';
                    resultsDiv.textContent = '‚ùå Aucun cache trouv√© dans localStorage';
                    log('‚ùå Aucun cache trouv√©', 'error');
                }
            } catch (error) {
                resultsDiv.className = 'result error';
                resultsDiv.textContent = `‚ùå Erreur: ${error.message}`;
                log(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }

        // Test 2: Appel API direct
        async function testAPICall() {
            log('üîç Test de l\'API /rest/node-types...', 'info');
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            resultsDiv.className = 'result';
            resultsDiv.textContent = '‚è≥ Appel en cours...';
            
            try {
                const baseUrl = window.location.origin;
                const nodeTypesUrl = `${baseUrl}/rest/node-types`;
                
                log(`üì° URL: ${nodeTypesUrl}`, 'info');
                
                const response = await fetch(nodeTypesUrl, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                log(`üì® Status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const nodeTypes = await response.json();
                const nodeCount = Object.keys(nodeTypes).length;
                
                resultsDiv.className = 'result success';
                resultsDiv.textContent = `‚úÖ API fonctionnelle!\n\n`;
                resultsDiv.textContent += `Nodes re√ßus: ${nodeCount}\n\n`;
                resultsDiv.textContent += `Exemples:\n`;
                
                const examples = Object.entries(nodeTypes).slice(0, 5);
                examples.forEach(([nodeType, versionData]) => {
                    const versions = Object.keys(versionData);
                    resultsDiv.textContent += `  ${nodeType}: versions ${versions.join(', ')}\n`;
                });
                
                log(`‚úÖ API OK: ${nodeCount} nodes re√ßus`, 'success');
                
            } catch (error) {
                resultsDiv.className = 'result error';
                resultsDiv.textContent = `‚ùå Erreur API: ${error.message}\n\n`;
                resultsDiv.textContent += `Ceci est normal si:\n`;
                resultsDiv.textContent += `- Vous n'√™tes pas sur une instance n8n\n`;
                resultsDiv.textContent += `- CORS bloque l'acc√®s\n`;
                resultsDiv.textContent += `- Authentification requise`;
                
                log(`‚ùå Erreur API: ${error.message}`, 'error');
            }
        }

        // Test 3: Via inject script (simulation)
        function testInjectScript() {
            log('üîç Simulation du script inject√©...', 'info');
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            
            // Simuler l'envoi d'un message
            window.postMessage({ type: 'GET_NODE_VERSIONS' }, '*');
            
            resultsDiv.className = 'result';
            resultsDiv.textContent = '‚è≥ Attente de la r√©ponse du script inject√©...\n\n';
            resultsDiv.textContent += 'Note: Cette m√©thode ne fonctionne que sur une vraie page n8n avec l\'extension charg√©e.';
            
            log('üì§ Message envoy√©, attente r√©ponse...', 'info');
            
            // √âcouter la r√©ponse
            const listener = (event) => {
                if (event.source !== window) return;
                if (event.data.type === 'NODE_VERSIONS_RESPONSE') {
                    window.removeEventListener('message', listener);
                    
                    if (event.data.versions) {
                        resultsDiv.className = 'result success';
                        resultsDiv.textContent = `‚úÖ Versions re√ßues via inject!\n\n`;
                        resultsDiv.textContent += `Nombre: ${Object.keys(event.data.versions).length}`;
                        
                        log(`‚úÖ Versions re√ßues: ${Object.keys(event.data.versions).length} nodes`, 'success');
                    } else {
                        resultsDiv.className = 'result error';
                        resultsDiv.textContent = '‚ùå Pas de versions re√ßues';
                        
                        log('‚ùå Pas de versions re√ßues', 'error');
                    }
                }
            };
            
            window.addEventListener('message', listener);
            
            // Timeout
            setTimeout(() => {
                window.removeEventListener('message', listener);
                if (!resultsDiv.textContent.includes('‚úÖ')) {
                    resultsDiv.className = 'result error';
                    resultsDiv.textContent = '‚ùå Timeout - Pas de r√©ponse du script inject√©\n\n';
                    resultsDiv.textContent += 'Ceci est normal si vous n\'√™tes pas sur une page n8n avec l\'extension.';
                    
                    log('‚è±Ô∏è Timeout - pas de r√©ponse', 'error');
                }
            }, 3000);
        }

        // Vider le cache
        function clearCache() {
            log('üóëÔ∏è Suppression du cache...', 'info');
            
            localStorage.removeItem('n8n-ai-node-versions');
            localStorage.removeItem('n8n-ai-node-versions-timestamp');
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            resultsDiv.className = 'result success';
            resultsDiv.textContent = '‚úÖ Cache supprim√© avec succ√®s';
            
            log('‚úÖ Cache supprim√©', 'success');
        }

        // Simulation du flux complet
        async function simulateFullFlow() {
            log('üöÄ D√©marrage de la simulation compl√®te...', 'info');
            const flowResult = document.getElementById('flow-result');
            flowResult.style.display = 'block';
            flowResult.className = 'result';
            flowResult.textContent = '‚è≥ Simulation en cours...\n\n';
            
            try {
                // √âtape 1: V√©rifier le cache
                log('1Ô∏è‚É£ V√©rification du cache...', 'info');
                const cached = localStorage.getItem('n8n-ai-node-versions');
                
                let versions = null;
                
                if (cached) {
                    versions = JSON.parse(cached);
                    log(`‚úÖ Cache trouv√©: ${Object.keys(versions).length} nodes`, 'success');
                    flowResult.textContent += `1Ô∏è‚É£ Cache trouv√©: ${Object.keys(versions).length} nodes ‚úÖ\n`;
                } else {
                    log('‚ö†Ô∏è Pas de cache, tentative API...', 'info');
                    flowResult.textContent += `1Ô∏è‚É£ Pas de cache ‚ö†Ô∏è\n`;
                    
                    // √âtape 2: Essayer l'API
                    try {
                        const response = await fetch('/rest/node-types', {
                            method: 'GET',
                            credentials: 'include',
                            headers: { 'Accept': 'application/json' }
                        });
                        
                        if (response.ok) {
                            const nodeTypes = await response.json();
                            // Transformer en versions
                            versions = {};
                            for (const [nodeType, versionData] of Object.entries(nodeTypes)) {
                                const simpleName = nodeType.split('.').pop();
                                const versionNumbers = Object.keys(versionData).map(v => parseInt(v)).filter(v => !isNaN(v));
                                if (versionNumbers.length > 0) {
                                    const maxVersion = Math.max(...versionNumbers);
                                    versions[simpleName] = maxVersion;
                                    versions[nodeType] = maxVersion;
                                }
                            }
                            
                            log(`‚úÖ API OK: ${Object.keys(versions).length} versions extraites`, 'success');
                            flowResult.textContent += `2Ô∏è‚É£ API fonctionnelle: ${Object.keys(versions).length} versions ‚úÖ\n`;
                            
                            // Sauvegarder dans le cache
                            localStorage.setItem('n8n-ai-node-versions', JSON.stringify(versions));
                            localStorage.setItem('n8n-ai-node-versions-timestamp', Date.now().toString());
                            flowResult.textContent += `3Ô∏è‚É£ Cache mis √† jour ‚úÖ\n`;
                        } else {
                            throw new Error(`HTTP ${response.status}`);
                        }
                    } catch (apiError) {
                        log(`‚ùå Erreur API: ${apiError.message}`, 'error');
                        flowResult.textContent += `2Ô∏è‚É£ Erreur API: ${apiError.message} ‚ùå\n`;
                        flowResult.textContent += `3Ô∏è‚É£ Fallback vers inject script (non simul√©) ‚ö†Ô∏è\n`;
                    }
                }
                
                // √âtape 3: Simuler l'envoi au backend
                if (versions) {
                    log('3Ô∏è‚É£ Simulation envoi au backend...', 'info');
                    
                    const payload = {
                        prompt: "Test avec versions",
                        context: { nodes: [], connections: {} },
                        mode: "create",
                        tools: [],
                        versions: versions
                    };
                    
                    const payloadSize = JSON.stringify(payload).length;
                    log(`üì¶ Taille du payload: ${payloadSize} octets`, 'info');
                    flowResult.textContent += `\n4Ô∏è‚É£ Payload pr√©par√©: ${payloadSize} octets ‚úÖ\n`;
                    flowResult.textContent += `5Ô∏è‚É£ Versions incluses: ${Object.keys(versions).length} nodes ‚úÖ\n`;
                    
                    // Afficher quelques exemples
                    flowResult.textContent += `\nExemples de versions:\n`;
                    const examples = Object.entries(versions).slice(0, 5);
                    examples.forEach(([node, version]) => {
                        flowResult.textContent += `  - ${node}: ${version}\n`;
                    });
                    
                    flowResult.className = 'result success';
                    flowResult.textContent += `\n‚úÖ Simulation r√©ussie! Les versions seraient envoy√©es au backend.`;
                } else {
                    flowResult.className = 'result error';
                    flowResult.textContent += `\n‚ùå Aucune version disponible √† envoyer.`;
                }
                
            } catch (error) {
                log(`‚ùå Erreur simulation: ${error.message}`, 'error');
                flowResult.className = 'result error';
                flowResult.textContent += `\n‚ùå Erreur: ${error.message}`;
            }
        }

        // Log initial
        log('üéØ Page de debug charg√©e', 'info');
        log('üí° Utilisez les boutons pour tester diff√©rentes m√©thodes de r√©cup√©ration des versions', 'info');
    </script>
</body>
</html> 